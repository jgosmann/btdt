<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>btdt - User Guide</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-850161a5.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-7bb95ebd.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">btdt - User Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/jgosmann/btdt" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="btdt-been-there-done-that"><a class="header" href="#btdt-been-there-done-that">btdt: “been there, done that”</a></h1>
<p><code>btdt</code> is a tool for flexible caching files in CI pipelines.
By being a simple CLI program, it is agnostic to the CI platform and can be integrated into various pipelines.</p>
<p>Cached data can either be stored locally in the filesystem, or remotely using the server component <code>btdt-server</code>.</p>
<p><strong>This tool is still under active development and not feature complete yet.</strong>
See below for details.</p>
<h2 id="example-caching-node_modules"><a class="header" href="#example-caching-node_modules">Example: caching <code>node_modules</code></a></h2>
<pre><code class="language-sh">CACHE_KEY=node-modules-$(btdt hash package-lock.json)
btdt restore --cache path/to/cache --keys $CACHE_KEY node_modules
if [ $? -ne 0 ]; then
    npm ci
    btdt store --cache path/to/cache --keys $CACHE_KEY node_modules
fi
</code></pre>
<p>Examples for specific CI platforms can be found in the documentation (see below).</p>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>The main user guide and documentation is located at <a href="https://jgosmann.github.io/btdt">https://jgosmann.github.io/btdt</a>.
The API documentation is found on <a href="https://docs.rs/btdt/latest/btdt/">docs.rs</a></p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>I was annoyed that there isn’t a good (self-hosted) caching solution for Jenkins and Tekton, similar to the
cache for GitHub Actions.
Also, it seemed that it shouldn’t be that hard to implement a caching solution.
So I put my money where my mouth is.
In particular, I didn’t see any reason why caching should be tied to a specific CI platform by implementing it as a
plugin for that platform.
To me, it seems, that this problem is solvable with a CLI tool that can be integrated into any pipeline.</p>
<p>Regarding Jenkins, I know of two caching plugins and I have my quarrels with both of them:</p>
<ul>
<li><a href="https://plugins.jenkins.io/jobcacher/">Job Cacher</a> will delete the complete cache once it reaches the maximum size.
This is inefficient and I prefer to delete least recently used caches until the limit is met. The plugin also does
not share the cache between different build jobs which severely limits its usefulness in certain scenarios. We also
had some other constraints that made it impossible to use this plugin, but a CLI tool could have been integrated
easily.</li>
<li><a href="https://github.com/j3t/jenkins-pipeline-cache-plugin">jenkins-pipeline-cache-plugin</a> requires S3 API compatible
storage, which excludes some other use cases. It also doesn’t seem to provide a way to limit the cache size.</li>
</ul>
<p>Regarding
Tekton, <a href="https://tekton.dev/blog/2023/11/02/speeding-up-container-image-builds-in-tekton-pipelines/#caching-dependencies-on-a-persistent-disk">a few suggestions are made in their blog</a>.
But I don’t think those are perfect:</p>
<ul>
<li>Caching layers in a container registry imposes a dependency order on your cached layers. This might be fine, if
invalidating one cache/layer, implies that all subsequent caches/layers are also invalidated. But if you have two
orthogonal caches, you must decide for an order, and always have one case where one of the caches might be invalidated
needlessly.</li>
<li>Caching on a persistent disk does not, as far as I understand, allow for multiple caches to be stored without
additional tooling. If you have builds that require different caches, you might end up overwriting caches constantly.
<code>btdt</code> provides tooling to have multiple separate caches.</li>
</ul>
<h2 id="state-of-development"><a class="header" href="#state-of-development">State of development</a></h2>
<p>A basic version of <code>btdt</code> that can be used in most scenarios is working.
Missing features concern primarily covenience and ease of use:</p>
<ul>
<li>Compression of the cache (to reduce the amount of data transferred).</li>
<li>Hashing multiple files in a stable way for the cache key.</li>
<li>A templating system for cache keys, such that <code>btdt hash</code> doesn’t need to be called,
but a cache key in the form of <code>cache-key-${hashFiles('**/package-lock.json')}</code> can be used directly.</li>
<li>Potentially, using S3 compatible APIs as storage backend.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>There are multiple ways to install <code>btdt</code>. Choose the method from below that best fits your needs.</p>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Currently, only Unix (Linux, macOS) systems are supported.</p>
</blockquote>
<h2 id="pre-compiled-binaries"><a class="header" href="#pre-compiled-binaries">Pre-compiled binaries</a></h2>
<p>You can download pre-compiled binaries from the <a href="https://github.com/jgosmann/btdt/releases?q=btdt-cli&amp;expanded=true">GitHub Releases
page</a> (look for <code>btdt-cli</code> releases).
The archive contains a single executable binary <code>btdt</code>.
You might want to place it in your <code>$PATH</code> for easy access.</p>
<p>For Linux, you have the choice between a version depending on a suffciently recent <code>glibc</code> version
(<code>-gnu</code> suffix) and a statically linked version (<code>-musl</code> suffix) that should work on most systems,
even without <code>glibc</code>.</p>
<h2 id="docker-images"><a class="header" href="#docker-images">Docker images</a></h2>
<p>Docker images are available on <a href="https://hub.docker.com/r/jgosmann/btdt">Docker Hub</a>.
This allows to directly run <code>btdt</code> without installing it on your system:</p>
<pre><code class="language-sh">docker run jgosmann/btdt btdt --help
</code></pre>
<p>However, you will have to mount the directories with the cache and the files to cache into the container.
This can be done with the <a href="https://docs.docker.com/engine/storage/volumes/#syntax"><code>--mount</code> or <code>--volume</code> option</a>.</p>
<p>The images use Semantic Versioning tags. For example, <code>jgosmann/btdt:0.1</code>
refers to the latest <code>v0.1.x</code> image.</p>
<h2 id="build-from-source-using-rust"><a class="header" href="#build-from-source-using-rust">Build from source using Rust</a></h2>
<p>If you have Rust installed, you can build <code>btdt</code> from source using <code>cargo</code>:</p>
<pre><code class="language-sh">cargo install btdt
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<p>This guide will show you the general steps of using <code>btdt</code> to cache files, in particular,
installed dependencies of a package manager such as <code>npm</code>.
If you are looking to integrate <code>btdt</code> into a CI pipeline,
you might want to also check out the <a href="#overview">CI-specific integration guides</a>.</p>
<h2 id="determining-cache-keys"><a class="header" href="#determining-cache-keys">Determining cache keys</a></h2>
<p>Usually, you will have a file that completely specifies the dependencies and their versions of your project.
For example, in the JavaScript/NPM ecosystem, this is the <code>package-lock.json</code> file.
As long as it doesn’t change, the installed dependencies will be the same and could be cached.
Thus, the primary cache key should be based on this file.</p>
<p>We can use the <code>btdt hash</code> command to generate a cache key from the file:</p>
<pre><code class="language-sh">CACHE_KEY=cache-key-$(btdt hash package-lock.json)
</code></pre>
<p>This calculates a cryptographic hash over the file contents and appends it to the string <code>cache-key-</code>.
The result could look something like <code>cache-key-f3dd7a501dd93486194e752557585a1996846b9a6df16e76f104e81192b0039f</code>.
If the <code>package-lock.json</code> file changes, the hash will change as well and the cache key will be different.</p>
<h2 id="trying-to-restore-the-cache"><a class="header" href="#trying-to-restore-the-cache">Trying to restore the cache</a></h2>
<p>Before we try to install the dependencies, e.g. with <code>npm ci</code>, we can try to restore the cache instead:</p>
<pre><code class="language-sh">btdt restore --cache path/to/cache --keys $CACHE_KEY node_modules
RESTORE_EXIT_CODE=$?
</code></pre>
<p><code>npm</code> will install the dependencies into <code>node_modules</code>, so we are using this as the target directory.
Furthermore, we will store the exit code because it comes in handy in the next step. It will be <code>0</code> if the cache was
restored successfully from the first given key, and non-zero otherwise. (Use the <code>--success-rc-on-any-key</code> flag to
return a zero exit code no matter the key that was used to restore the cache.)</p>
<h2 id="installing-dependencies-and-storing-the-cache"><a class="header" href="#installing-dependencies-and-storing-the-cache">Installing dependencies and storing the cache</a></h2>
<p>If the cache could not be restored, we will install the dependencies with <code>npm ci</code>, and then store the installed
dependencies in the cache:</p>
<pre><code class="language-sh">if [ $RESTORE_EXIT_CODE -ne 0 ]; then
    npm ci  # Install dependencies
    btdt store --cache path/to/cache --keys $CACHE_KEY node_modules
fi
</code></pre>
<h2 id="using-multiple-cache-keys"><a class="header" href="#using-multiple-cache-keys">Using multiple cache keys</a></h2>
<p>You can specify multiple cache keys. This allows to have a fallback mechanism. The cache keys will be tried in order
during the restore operation and allow you to use a cache which might not contain the exact dependencies required, but
could still speed up the installation if most of them are contained.</p>
<p>With <code>npm</code> the usage of multiple cache keys could look like this:</p>
<pre><code class="language-sh">CACHE_KEY=cache-key-$(btdt hash package-lock.json)

btdt restore --cache path/to/cache --keys "$CACHE_KEY,fallback" node_modules
RESTORE_EXIT_CODE=$?

npm ci

if [ $RESTORE_EXIT_CODE -ne 0 ]; then
    btdt store --cache path/to/cache --keys $CACHE_KEY,fallback node_modules
fi
</code></pre>
<p>This will store the latest cached dependencies also under the key <code>fallback</code>. This cache entry will be used, if no more
specific cache enry is found.</p>
<h2 id="using-a-remote-cache"><a class="header" href="#using-a-remote-cache">Using a remote cache</a></h2>
<p>Instead of using a local filesystem path for the cache, you can also use a remote cache server.
For this, you need to have a <code>btdt-server</code> instance running somewhere.
You can then specify the URL of the cache endpoint and the file with the authentication token,
to use the remote cache:</p>
<pre><code class="language-sh"># restore
btdt restore \
  --cache https://btdt-server.example.com:8707/api/caches/cache-name \
  --auth-token-file ./auth-token \
  --keys "$CACHE_KEY" \
  node_modules

# store
btdt store \
  --cache https://btdt-server.example.com:8707/api/caches/cache-name \
  --auth-token-file ./auth-token \
  --keys "$CACHE_KEY" \
  node_modules
</code></pre>
<p>Note that the file with the authentication token must be readable only by the user running <code>btdt</code>.</p>
<h2 id="cleanup"><a class="header" href="#cleanup">Cleanup</a></h2>
<p>To prevent a local cache from growing indefinitely, you might want to clean up old cache entries from time to time, for
example to only keep cache entries accessed within the last seven days and limit the cache size to at most 10 GiB:</p>
<pre><code class="language-sh">btdt clean --cache path/to/cache --max-age 7d --max-size 10GiB
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="deployment"><a class="header" href="#deployment">Deployment</a></h1>
<p>The <code>btdt-server</code> is a server application that allows to store and retrieve cached files with <code>btdt</code> on this server.</p>
<h2 id="installation-1"><a class="header" href="#installation-1">Installation</a></h2>
<p>There are multiple ways to install <code>btdt-server</code>. Choose the method from below that best fits your needs.</p>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Currently, only Unix (Linux, macOS) systems are supported.</p>
</blockquote>
<h3 id="pre-compiled-binaries-1"><a class="header" href="#pre-compiled-binaries-1">Pre-compiled binaries</a></h3>
<p>You can download pre-compiled binaries from the <a href="https://github.com/jgosmann/btdt/releases?q=btdt-server&amp;expanded=true">GitHub Releases
page</a> (look for <code>btdt-server</code> releases).
The archive contains a single executable binary <code>btdt-server</code> that will start the server.</p>
<h3 id="docker-images-1"><a class="header" href="#docker-images-1">Docker images</a></h3>
<p>Docker images are available on <a href="https://hub.docker.com/r/jgosmann/btdt-server">Docker Hub</a>.</p>
<p>The images use Semantic Versioning tags. For example, <code>jgosmann/btdt-server:0.1</code> refers to the latest <code>v0.1.x</code> image.</p>
<p>When running the container, you likely want to mount a few files or directories into the container:</p>
<ul>
<li>The directory where caches are stored, so that they are persisted across container restarts.</li>
<li>The configuration file (default: <code>/config.toml</code>).</li>
<li>The file with the private key for authentication (default: <code>/auth_private_key.pem</code>).</li>
<li>If using TLS, the PKCS#12 file with the TLS certificate and private key.</li>
</ul>
<p>Note that, if you are using TLS, you will have to override the default health check command with:</p>
<pre><code class="language-Dockerfile">HEALTHCHECK CMD ["btdt-server", "health-check", "https://localhost:8707/api/health"]
</code></pre>
<p>It is important to use the <code>CMD</code> form of the <code>HEALTHCHECK</code> instruction here, and not the <code>CMD-SHELL</code> form.
The latter would require a shell to be present in the container, which is not the case for the <code>btdt-server</code>
distroless image.</p>
<h3 id="build-from-source-using-rust-1"><a class="header" href="#build-from-source-using-rust-1">Build from source using Rust</a></h3>
<p>If you have Rust installed, you can build <code>btdt-server</code> from source using <code>cargo</code>:</p>
<pre><code class="language-sh">cargo install btdt-server
</code></pre>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>The <code>btdt-server</code> is configured via a TOML configuration file at <code>/etc/btdt-server/config.toml</code>
(or <code>/config.toml</code> within the provided container image).</p>
<p>A minimal configuration should configure at least the location of the authorization private key and one cache location:</p>
<pre><code class="language-toml">auth_private_key = "/etc/btdt-server/auth_private_key.pem"

[caches]
default = { type = 'Filesystem', path = '/var/lib/btdt/default' }
</code></pre>
<p>Note that the <code>auth_private_key</code> can alternatively also be set through the environment variable <code>BTDT_AUTH_PRIVATE_KEY</code>.</p>
<p>The URL to this cache location for <code>btdt</code> would be <code>http(s)://&lt;btdt-server-host&gt;:8707/api/caches/default</code>.</p>
<p>See <a href="#configuration-1">the configuration documentation</a> for more details on the available configuration options.</p>
<h2 id="authorization"><a class="header" href="#authorization">Authorization</a></h2>
<p>Authorization is done with <a href="https://www.biscuitsec.org/">Eclipse Biscuit</a> tokens.
This avoids the need to manage user accounts on the server.
The server only needs to have a private key to verify the tokens.
If the private key is not present at server startup, a new key will be generated.</p>
<p>To generate the private key and derive authentication tokens, use the <code>biscuit</code> command line tool that can be
installed with</p>
<pre><code class="language-sh">cargo install biscuit-cli
</code></pre>
<p>A new private key can be generated with</p>
<pre><code class="language-sh">biscuit keypair --key-output-format pem --only-private-key | head -c -1 &gt; auth_private_key.pem
</code></pre>
<p>To generate a new authorization token with all permissions and validity of 90 days, use</p>
<pre><code class="language-sh">biscuit generate \
  --private-key-file auth_private_key.pem \
  --private-key-format pem \
  --add-ttl 90d - &lt;&lt;EOF
EOF
</code></pre>
<p>See <a href="#authorization-1">the authorization documentation</a> for more details.</p>
<h2 id="enabling-tls"><a class="header" href="#enabling-tls">Enabling TLS</a></h2>
<p>To enable TLS, simply provide a PKCS#12 file with the TLS certificate and private key.
Configure the path to this file with the <code>tls_keystore</code> option in the configuration file
or the <code>BTDT_TLS_KEYSTORE</code> environment variable. a password for the keystore can be provided
with the <code>tls_keystore_password</code> option or the <code>BTDT_TLS_KEYSTORE_PASSWORD</code> environment variable.</p>
<p>Note that, if you are using the <code>btdt-server</code> container image, you will have to adapt the health check command to:</p>
<pre><code class="language-Dockerfile">HEALTHCHECK CMD ["btdt-server", "health-check", "https://localhost:8707/api/health"]
</code></pre>
<p>It is important to use the <code>CMD</code> form of the <code>HEALTHCHECK</code> instruction here, and not the <code>CMD-SHELL</code> form.
The latter would require a shell to be present in the container, which is not the case for the <code>btdt-server</code>
distroless image.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h1>
<p>The <code>btdt-server</code> is configured via a TOML configuration file at <code>/etc/btdt-server/config.toml</code>
(or <code>/config.toml</code> within the provided container image).
This location can be overridden by setting the <code>BTDT_SERVER_CONFIG_FILE</code> environment variable.
Some configuration options can also be set via environment variables, as described below.</p>
<h2 id="general-options"><a class="header" href="#general-options">General options</a></h2>
<h3 id="auth_private_key"><a class="header" href="#auth_private_key"><code>auth_private_key</code></a></h3>
<ul>
<li><strong>Type:</strong> string</li>
<li><strong>Default:</strong> <code>''</code></li>
<li><strong>Environment variable:</strong> <code>BTDT_AUTH_PRIVATE_KEY</code></li>
</ul>
<p>Path to the <a href="https://www.biscuitsec.org/">Eclipse Biscuit</a> private key file used to verify authorization tokens.
If the file does not exist at server startup, a new private key will be generated and saved to this location.
Note that the private key’s permission must be restricted to <code>0600</code>.</p>
<h3 id="bind_addrs"><a class="header" href="#bind_addrs"><code>bind_addrs</code></a></h3>
<ul>
<li><strong>Type:</strong> array of strings</li>
<li><strong>Default:</strong> <code>['0.0.0.0:8707']</code></li>
<li><strong>Environment variable:</strong> <code>BTDT_BIND_ADDRS</code></li>
</ul>
<p>List of addresses and ports the server should bind to.</p>
<h3 id="enable_api_docs"><a class="header" href="#enable_api_docs"><code>enable_api_docs</code></a></h3>
<ul>
<li><strong>Type:</strong> boolean</li>
<li><strong>Default:</strong> <code>true</code></li>
<li><strong>Environment variable:</strong> <code>BTDT_ENABLE_API_DOCS</code></li>
</ul>
<p>If set to <code>true</code>, the server will provide API documentation at <code>/docs</code>.</p>
<h3 id="tls_keystore"><a class="header" href="#tls_keystore"><code>tls_keystore</code></a></h3>
<ul>
<li><strong>Type:</strong> string</li>
<li><strong>Default:</strong> <code>''</code></li>
<li><strong>Environment variable:</strong> <code>BTDT_TLS_KEYSTORE</code></li>
</ul>
<p>Path to a PKCS#12 keystore file containing the TLS certificate and private key.
If not set, the server will run without TLS.</p>
<h3 id="tls_keystore_password"><a class="header" href="#tls_keystore_password"><code>tls_keystore_password</code></a></h3>
<ul>
<li><strong>Type:</strong> string</li>
<li><strong>Default:</strong> <code>''</code></li>
<li><strong>Environment variable:</strong> <code>BTDT_TLS_KEYSTORE_PASSWORD</code></li>
</ul>
<p>Password for the PKCS#12 keystore file.</p>
<h2 id="cleanup-options"><a class="header" href="#cleanup-options">Cleanup options</a></h2>
<p>These options have to be set in the <code>[cleanup]</code> table.
They configure automatic cleanup of cached data to prevent indefinite growth of the cache storage.</p>
<h3 id="cache_expiration"><a class="header" href="#cache_expiration"><code>cache_expiration</code></a></h3>
<ul>
<li><strong>Type:</strong> duration string</li>
<li><strong>Default:</strong> <code>'7days'</code></li>
<li><strong>Environment variable:</strong> <code>BTDT_CLEANUP__CACHE_EXPIRATION</code></li>
</ul>
<p>Caches that have not been accessed for this duration will be deleted during cleanup runs.</p>
<h3 id="interval"><a class="header" href="#interval"><code>interval</code></a></h3>
<ul>
<li><strong>Type:</strong> duration string</li>
<li><strong>Default:</strong> <code>'10min'</code></li>
<li><strong>Environment variable:</strong> <code>BTDT_CLEANUP__INTERVAL</code></li>
</ul>
<p>Interval between cleanup runs.</p>
<h3 id="max_cache_size"><a class="header" href="#max_cache_size"><code>max_cache_size</code></a></h3>
<ul>
<li><strong>Type:</strong> size string</li>
<li><strong>Default:</strong> <code>'50GiB'</code></li>
<li><strong>Environment variable:</strong> <code>BTDT_CLEANUP__MAX_CACHE_SIZE</code></li>
</ul>
<p>Maximum total size of each cache. Note that a cache might temporarily exceed this size between cleanup runs.</p>
<h2 id="configuring-caches"><a class="header" href="#configuring-caches">Configuring caches</a></h2>
<p>Caches are configured in the <code>[caches]</code> table.
Each table entry defines a cache with a unique name.
The cache base URL is derived form this name and of the form
<code>http(s)://&lt;btdt-server-host&gt;:8707/api/caches/&lt;cache-name&gt;</code>.</p>
<h3 id="filesystem-cache"><a class="header" href="#filesystem-cache">Filesystem cache</a></h3>
<p>A filesystem cache stores cached data in a directory on the local filesystem.</p>
<pre><code class="language-toml">[caches]
my_cache = { type = 'Filesystem', path = '/var/lib/btdt/my_cache' }
</code></pre>
<h3 id="in-memory-cache"><a class="header" href="#in-memory-cache">In-memory cache</a></h3>
<p>An in-memory cache stores cached data in memory.
This cache is not persistent and will be lost when the server restarts.</p>
<blockquote class="blockquote-tag blockquote-tag-important">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>In-memory caches are intended for testing or development purposes.
They are not optimized for speed and might not perform well for production workloads.</p>
</blockquote>
<pre><code class="language-toml">[caches]
my_cache = { type = 'InMemory' }
</code></pre>
<h2 id="example-configuration"><a class="header" href="#example-configuration">Example configuration</a></h2>
<pre><code class="language-toml">bind_addrs = ['127.0.0.1:8707', '[::1]:8707']
enable_api_docs = false
tls_keystore = 'path/certificate.p12'
tls_keystore_password = 'password'
auth_private_key = 'path/private-key'

[cleanup]
interval = '5min'
cache_expiration = '14days'
max_cache_size = '100GiB'

[caches]
in_memory = { type = 'InMemory' }
filesystem = { type = 'Filesystem', path = '/var/lib/btdt-server/cache' }
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="authorization-1"><a class="header" href="#authorization-1">Authorization</a></h1>
<p>Authorization is done with <a href="https://www.biscuitsec.org/">Eclipse Biscuit</a> tokens.
This avoids the need to manage user accounts on the server.
The server only needs to have a private key to verify the tokens.</p>
<p>To manage private keys and authorization tokens, use the <code>biscuit</code> command line tool that can be
installed with</p>
<pre><code class="language-sh">cargo install biscuit-cli
</code></pre>
<h2 id="private-authorization-key"><a class="header" href="#private-authorization-key">Private authorization key</a></h2>
<p>The server uses a private key to verify the validity of authorization tokens.</p>
<p>The location of the private key can be configured via the <code>auth_private_key</code> configuration option
(or the <code>BTDT_AUTH_PRIVATE_KEY</code> environment variable). Note that the private key’s permission must be restricted to
<code>0600</code>.</p>
<p>If the private key is not present at server startup, a new key will be generated.</p>
<p>To manually generate a new private key, use</p>
<pre><code class="language-sh">biscuit keypair --key-output-format pem --only-private-key | head -c -1 &gt; auth_private_key.pem
</code></pre>
<p>(The <code>biscuit</code> tool outputs a trailing newline that prevents reading it to generate tokens, so we remove it with
<code>head -c -1</code>.)</p>
<h2 id="generating-authorization-tokens"><a class="header" href="#generating-authorization-tokens">Generating authorization tokens</a></h2>
<p>To generate a new authorization token with all permissions and validity of 90 days, use</p>
<pre><code class="language-sh">biscuit generate \
  --private-key-file auth_private_key.pem \
  --private-key-format pem \
  --add-ttl 90d - &lt;&lt;EOF
EOF
</code></pre>
<p>This will output a new authorization token that can be used with <code>btdt</code> to access the server.</p>
<p>It is also possible to restrict the permissions of the token by adding
additional <a href="https://doc.biscuitsec.org/reference/datalog.html">Datalog</a> statements.
For this, the following facts can be used:</p>
<ul>
<li><code>cache($cache_id)</code> declares the cache that is being accessed.</li>
<li><code>operation($op)</code> declares the operation being performed. Valid operations are <code>get</code> and <code>put</code>.</li>
</ul>
<p>For example, to generate a token that only allows reading from the cache <code>my-cache</code>, use</p>
<pre><code class="language-sh">biscuit generate \
  --private-key-file auth_private_key.pem \
  --private-key-format pem \
  --add-ttl 90d - &lt;&lt;EOF
  check if operation("get");
  check if cache("my-cache");
EOF
</code></pre>
<h2 id="attenuating-authorization-tokens"><a class="header" href="#attenuating-authorization-tokens">Attenuating authorization tokens</a></h2>
<p>Authorization tokens can be attenuated to further restrict their permissions or validity period.
To attenuate a token, use the <code>biscuit attenuate</code> command.
For example, to attenuate an existing token to only allow accessing the cache <code>my-cache</code> for another 30 days, use</p>
<pre><code class="language-sh">biscuit attenuate \
    --block 'check if cache("my-cache");' \
    --add-ttl 30d \
    file-with-token
</code></pre>
<h2 id="revoking-authorization-tokens"><a class="header" href="#revoking-authorization-tokens">Revoking authorization tokens</a></h2>
<p>Revocation is not yet implemented. If you have to revoke a token, you will have to rotate the private key and issue
new tokens.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>While the <a href="#getting-started">Getting Started</a> guide provides a high-level overview of how to use <code>btdt</code>,
this section contains guides for specific CI systems:</p>
<ul>
<li><a href="#tekton">Tekton</a></li>
</ul>
<p>If you have experience with a CI system that is not covered here, please consider contributing a guide.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="tekton"><a class="header" href="#tekton">Tekton</a></h1>
<p>This guide explains how to use <code>btdt</code> in a <a href="https://tekton.dev/">Tekton</a> pipeline.
It will use the Docker images, so that no changes to the images of your tasks are necessary.
Of course, you could also install <code>btdt</code> within the respective task images which might simplify the integration a bit.</p>
<h2 id="provide-a-persistent-volume-claim-as-workspace-to-the-pipeline-run"><a class="header" href="#provide-a-persistent-volume-claim-as-workspace-to-the-pipeline-run">Provide a Persistent Volume Claim as workspace to the pipeline run</a></h2>
<p>To use <code>btdt</code> in a Tekton pipeline, you need to provide a Persistent Volume Claim (PVC) for the cache.
This PVC should be provided as actual <code>persistentVolumeClaim</code> in the <code>PipelineRun</code>, not <code>volumeClaimTemplate</code>.
Otherwise, you will have a fresh volume on each pipeline run, making the cache useless.
An example <code>PipelineRun</code> could look like this:</p>
<pre><code class="language-yaml"># PipelineRun template, e.g. as part of your trigger
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: my-pipeline-run-$(uid)
spec:
  params:
  # ...
  pipelineRef:
    name: my-tekton-pipeline
  workspaces:
    - name: cache
      persistentVolumeClaim:
        claimName: my-tekton-cache
</code></pre>
<p>With the default Tekton settings (at time of writing), only a single PVC can be mounted into a task.
Thus, if you are already using a PVC for you task (likely to check out your source code repository),
you will have to also store the cache on this PVC.</p>
<p>Alternatively, you can disable the <a href="https://tekton.dev/docs/pipelines/affinityassistants/">affinity assistant</a> to be
able to mount multiple PVCs into a task. Run <code>kubectl edit configmap feature-flags</code> to edit the configuration.
In the following, we assume this second setup. If you are using a single PVC, you will have to adjust the paths
accordingly.</p>
<h2 id="provide-the-cache-workspace-to-the-task"><a class="header" href="#provide-the-cache-workspace-to-the-task">Provide the cache workspace to the task</a></h2>
<p>To be able to use the cache in a task, the cache workspace needs to be provided:</p>
<pre><code class="language-yaml"># pipeline.yaml
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: my-tekton-pipeline
spec:
  workspaces:
    - name: cache
  tasks:
    - name: run-tests
      taskRef:
        name: run-tests
        kind: Task
      workspaces:
        - name: git-sources
          workspace: git-sources
        - name: cache
          workspace: cache
</code></pre>
<h2 id="use-the-cache-in-a-task"><a class="header" href="#use-the-cache-in-a-task">Use the cache in a task</a></h2>
<p>You must declare the cache workspace in the task, so that it can be used by the individual steps:</p>
<pre><code class="language-yaml"># task_run-tests.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: run-tests
spec:
  steps:
  # ...
  workspaces:
    - name: git-sources
      description: Provides the workspace with the cloned repository.
    - name: cache
      description: Provides the btdt cache.
</code></pre>
<h3 id="restore-the-cache"><a class="header" href="#restore-the-cache">Restore the cache</a></h3>
<p>Now you can add a step to restore the cache at the beginning of the task.
Here, we try to restore a <code>node_modules</code> directory:</p>
<pre><code class="language-yaml"># task_run-tests.yaml
spec:
  # ...
  steps:
    - name: restore-cache
      image: jgosmann/btdt:0.1
      workingDir: $(workspaces.cache.path)
      onError: continue
      script: |
        #!/bin/sh
        CACHE_KEY=node-modules-$(btdt hash package-lock.json)
        echo "Cache key: $CACHE_KEY"
        btdt restore --cache $(workspaces.cache.path) --keys $CACHE_KEY node_modules
</code></pre>
<h3 id="install-dependencies-only-on-cache-miss"><a class="header" href="#install-dependencies-only-on-cache-miss">Install dependencies only on cache miss</a></h3>
<p>Depending on what you are caching, you might want to run some commands only a cache miss to generate the files that
would be cached.
For example, to install NPM dependencies only if the cache could not be restored:</p>
<pre><code class="language-yaml"># task_run-tests.yaml
spec:
  # ...
  steps:
    # try restore
    - name: run-tests
      image: node
      workingDir: $(workspaces.git-sources.path)
      script: |
        #!/bin/sh
        if [ $(cat $(steps.step-restore-cache.exitCode.path)) -eq 0 ]; then
          echo "Cache restore succeeded, skipping npm ci"
        else
          npm ci
        fi
        # run tests, build, etc.
</code></pre>
<p>Note, if you are using <a href="#using-multiple-cache-keys">fallback keys</a>, you would always want to run
<code>npm ci</code> to ensure that the dependencies are installed correctly.</p>
<h3 id="store-the-cache"><a class="header" href="#store-the-cache">Store the cache</a></h3>
<p>For the cache to provide a benefit, we need to fill it if a cache miss occurred. This requires an additional step
after the files to cache have been generated (e.g. by running <code>npm ci</code>):</p>
<pre><code class="language-yaml"># task_run-tests.yaml
spec:
  # ...
  steps:
    # try restore
    # install dependencies/generate files to cache
    - name: store-cache
      image: jgosmann/btdt:0.1
      workingDir: $(workspaces.git-sources.path)
      script: |
        #!/bin/sh
        if [ $(cat $(steps.step-restore-cache.exitCode.path)) -eq 0 ]; then
            echo "Cache restore succeeded, skipping cache store"
            exit 0
        fi
        CACHE_KEY=node-modules-$(btdt hash package-lock.json)
        echo "Cache key: $CACHE_KEY"
        btdt store --cache $(workspaces.cache.path) --keys $CACHE_KEY node_modules
</code></pre>
<h3 id="example-of-complete-task"><a class="header" href="#example-of-complete-task">Example of complete task</a></h3>
<p>When putting all of this together, your task definition will look something like this:</p>
<pre><code class="language-yaml"># task_run-tests.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: run-tests
spec:
  steps:
    - name: restore-cache
      image: jgosmann/btdt:0.1
      workingDir: $(workspaces.git-sources.path)
      onError: continue
      script: |
        #!/bin/sh
        CACHE_KEY=node-modules-$(btdt hash package-lock.json)
        echo "Cache key: $CACHE_KEY"
        btdt restore --cache $(workspaces.cache.path) --keys $CACHE_KEY node_modules
    - name: run-tests
      image: node
      workingDir: $(workspaces.git-sources.path)
      script: |
        #!/bin/sh
        if [ $(cat $(steps.step-restore-cache.exitCode.path)) -eq 0 ]; then
          echo "Cache restore succeeded, skipping npm ci"
        else
          npm ci
        fi
        # run tests etc.
    - name: store-cache
      image: jgosmann/btdt
      workingDir: $(workspaces.git-sources.path)
      script: |
        #!/bin/sh
        if [ $(cat $(steps.step-restore-cache.exitCode.path)) -eq 0 ]; then
            echo "Cache restore succeeded, skipping cache store"
            exit 0
        fi
        CACHE_KEY=node-modules-$(btdt hash package-lock.json)
        echo "Cache key: $CACHE_KEY"
        btdt store --cache $(workspaces.cache.path) --keys $CACHE_KEY node_modules

  workspaces:
    - name: git-sources
      description: Provides the workspace with the cloned repository.
    - name: cache
      description: Provides btdt cache.
</code></pre>
<h2 id="cleanup-1"><a class="header" href="#cleanup-1">Cleanup</a></h2>
<p>To prevent the cache from growing indefinitely, you should configure a regular cleanup:</p>
<h3 id="clean-task"><a class="header" href="#clean-task">Clean task</a></h3>
<pre><code class="language-yaml"># task_cache-clean.yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: cache-clean
spec:
  steps:
    - name: cache-clean
      image: jgosmann/btdt:0.1
      script: |
        #!/bin/sh
        btdt clean --cache $(workspaces.cache.path) --max-age 7d --max-size 10GiB
  workspaces:
    - name: cache
      description: Provides the btdt cache.
</code></pre>
<h3 id="clean-pipeline"><a class="header" href="#clean-pipeline">Clean pipeline</a></h3>
<pre><code class="language-yaml"># pipeline_cache-clean.yaml
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: cache-clean-pipeline
spec:
  workspaces:
    - name: cache
  params:
    - name: runid
      type: string
  tasks:
    - name: cache-clean
      taskRef:
        name: cache-clean
        kind: Task
      workspaces:
        - name: cache
          workspace: cache
</code></pre>
<h3 id="cron-trigger"><a class="header" href="#cron-trigger">Cron trigger</a></h3>
<pre><code class="language-yaml"># trigger_cache-clean.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cache-clean-schedule
spec:
  schedule: '@hourly'
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: cache-clean-trigger
              image: curlimages/curl
              command: [ '/bin/sh', '-c' ]
              args: [ "curl --header \"Content-Type: application/json\" --data '{}' el-cache-clean-listener.default.svc.cluster.local:8080" ]
          restartPolicy: Never

---
apiVersion: triggers.tekton.dev/v1alpha1
kind: EventListener
metadata:
  name: cache-clean-listener
spec:
  triggers:
    - name: cache-clean-trigger
      interceptors: [ ]
      template:
        spec:
          resourcetemplates:
            - apiVersion: tekton.dev/v1beta1
              kind: PipelineRun
              metadata:
                name: cache-clean-$(uid)
              spec:
                pipelineRef:
                  name: cache-clean-pipeline
                params:
                  - name: runid
                    value: $(uid)
                workspaces:
                  - name: cache
                    persistentVolumeClaim:
                      claimName: my-tekton-cache
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>

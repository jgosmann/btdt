<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introduction - btdt - User Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">btdt - User Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/jgosmann/btdt" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/jgosmann/btdt/edit/main/src/intro.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="btdt-been-there-done-that"><a class="header" href="#btdt-been-there-done-that">btdt: "been there, done that"</a></h1>
<p><code>btdt</code> is a tool for flexible caching files in CI pipelines.
By being a simple CLI program, it is agnostic to the CI platform and can be integrated into various pipelines.</p>
<p><strong>This tool is still under active development and not feature complete yet.</strong>
See below for details.</p>
<h2 id="example-caching-node_modules"><a class="header" href="#example-caching-node_modules">Example: caching <code>node_modules</code></a></h2>
<pre><code class="language-sh">CACHE_KEY=node-modules-$(btdt hash package-lock.json)
btdt restore --cache path/to/cache --keys $CACHE_KEY node_modules
if [ $? -ne 0 ]; then
    npm ci
    btdt store --cache path/to/cache --keys $CACHE_KEY node_modules
fi
</code></pre>
<p>Examples for specific CI platforms can be found in the documentation (see below).</p>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>The main user guide and documentation is located at <a href="https://jgosmann.github.io/btdt">https://jgosmann.github.io/btdt</a>.
The API documentation is found on <a href="https://docs.rs/btdt/latest/btdt/">docs.rs</a></p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>I was annoyed that there isn't a good (self-hosted) caching solution for Jenkins and Tekton, similar to the
cache for GitHub Actions.
Also, it seemed that it shouldn't be that hard to implement a caching solution.
So I put my money where my mouth is.
In particular, I didn't see any reason why caching should be tied to a specific CI platform by implementing it as a
plugin for that platform.
To me, it seems, that this problem is solvable with a CLI tool that can be integrated into any pipeline.</p>
<p>Regarding Jenkins, I know of two caching plugins and I have my quarrels with both of them:</p>
<ul>
<li><a href="https://plugins.jenkins.io/jobcacher/">Job Cacher</a> will delete the complete cache once it reaches the maximum size.
This is inefficient and I prefer to delete least recently used caches until the limit is met. The plugin also does
not share the cache between different build jobs which severely limits its usefulness in certain scenarios. We also
had some other constraints that made it impossible to use this plugin, but a CLI tool could have been integrated.</li>
<li><a href="https://github.com/j3t/jenkins-pipeline-cache-plugin">jenkins-pipeline-cache-plugin</a> requires S3 API compatible
storage, which excludes some other use cases. It also doesn't seem to provide a way to limit the cache size.</li>
</ul>
<p>Regarding
Tekton, <a href="https://tekton.dev/blog/2023/11/02/speeding-up-container-image-builds-in-tekton-pipelines/#caching-dependencies-on-a-persistent-disk">a few suggestions are made in their blog</a>.
But I don't think those are perfect:</p>
<ul>
<li>Caching layers in a container registry imposes a dependency order on your cached layers. This might be fine, if
invalidating one cache/layer, implies that all subsequent caches/layers are also invalidated. But if you have two
orthogonal caches, you must decide for an order, and always have one case where one of the caches might be invalidated
needlessly.</li>
<li>Caching on a persistent disk does not, as far as I understand, allow for multiple caches to be stored without
additional tooling. If you have builds that require different caches, you might end up overwriting caches constantly.
<code>btdt</code> provides tooling to have multiple separate caches.</li>
</ul>
<h2 id="state-of-development"><a class="header" href="#state-of-development">State of development</a></h2>
<p>A basic version of <code>btdt</code> that can be used in some scenarios is working.
I still intend to implement the following features:</p>
<ul>
<li>A server for storing caches remotely.</li>
<li>Compression of the cache (to reduce the amount of data transferred).</li>
<li>Hashing multiple files in a stable way for the cache key.</li>
<li>A templating system for cache keys, such that <code>btdt hash</code> doesn't need to be called,
but a cache key in the form of <code>cache-key-${hashFiles('**/package-lock.json')}</code> can be used directly.</li>
<li>Potentially, configuration via environment variables and/or configuration files.</li>
<li>Potentially, using S3 compatible APIs as storage backend.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->

                            <a rel="next prefetch" href="install.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

                    <a rel="next prefetch" href="install.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
